<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BHB Maternal Health Chat</title>
    <link rel="stylesheet" href="https://integraled.github.io/recursive-learning/docs/assets/css/ie-central.css">
    <link rel="stylesheet" href="https://integraled.github.io/recursive-learning/docs/clients/BHB/css/style.css">
    <style>
        html, body, #chat-container {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <div id="chat-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Function to parse query parameters
            function getQueryParams() {
                const params = new URLSearchParams(window.location.search);
                return {
                    User_ID: params.get('User_ID') || 'anonymous',
                    Thread_ID: params.get('Thread_ID') || '----',
                    Action_ID: params.get('Action_ID') || 'recan2bciV7HcjXHV', // Default to RAG Chat Action_ID
                    Org_ID: params.get('Org_ID') || 'recTpsAWPW6z64RVV', // BHB Org_ID
                    source: params.get('source') || 'bmore'
                };
            }

            // Retrieve user data from query parameters
            const config = getQueryParams();
            console.log('Config:', config);

            // Initialize the chat interface
            initChat(config);

            function initChat(config) {
                console.log('Initializing Chat with config:', config);

                // Construct the webhook URL
                const webhookUrl = `https://hook.us1.make.com/oh4b9kqlf1gnlypxasliklmc0jkwoi2t?User_ID=${encodeURIComponent(config.User_ID)}&Org_ID=${encodeURIComponent(config.Org_ID)}&Thread_ID=${encodeURIComponent(config.Thread_ID)}&Action_ID=${encodeURIComponent(config.Action_ID)}&Source=${encodeURIComponent(config.source)}`;

                // Make the webhook call
                fetch(webhookUrl)
                    .then(response => response.json())
                    .then(data => {
                        // Handle the response
                        if (data && data.Thread_ID) {
                            console.log('Received Thread_ID:', data.Thread_ID);
                            // Initialize chat interface with the received Thread_ID
                            loadChatInterface(data.Thread_ID, config);
                        } else {
                            console.warn('No Thread_ID received from the webhook.');
                            // Fallback to Business Analyst Chat
                            config.Action_ID = 'reci08vuv7qfN6D84'; // Business Analyst Action_ID
                            initChat(config);
                        }
                    })
                    .catch(error => {
                        console.error('Error initializing chat:', error);
                        alert('An error occurred while initializing chat. Please try again later.');
                    });
            }

            // Function to load the chat interface
            function loadChatInterface(threadId, config) {
                console.log('Loading chat interface with Thread_ID:', threadId);
                const chatContainer = document.getElementById('chat-container');
                const chatAppUrl = `https://integraled.github.io/recursive-learning/docs/clients/BHB/chat.html?Thread_ID=${encodeURIComponent(threadId)}&User_ID=${encodeURIComponent(config.User_ID)}&Org_ID=${encodeURIComponent(config.Org_ID)}`;

                // Create and configure iframe
                const iframe = document.createElement('iframe');
                iframe.src = chatAppUrl;
                iframe.width = '100%';
                iframe.height = '100%';
                iframe.frameBorder = '0';
                iframe.allow = 'camera; microphone; autoplay; encrypted-media';
                iframe.title = 'Chat Application';

                // Clear any existing content and append the iframe
                chatContainer.innerHTML = '';
                chatContainer.appendChild(iframe);
            }
        });
    </script>
</body>
</html>
