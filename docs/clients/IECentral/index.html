<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IE Central Support Chat</title>
    <!-- Favicon (if any) -->
    <link rel="icon" href="assets/logo.ico">
    <!-- Corrected CSS Paths -->
    <link rel="stylesheet" href="styles/variables.css">
    <link rel="stylesheet" href="styles/custom.css">
    <!-- Corrected CSS and JS Paths -->
    <link rel="stylesheet" href="../../Assets/css/ie-core.css">
</head>
<body>
    <!-- Corrected Image Path -->
    <img src="assets/logo.png" alt="Logo" class="logo">

    <!-- Main Content -->
    <main>
        <!-- Chat Interface -->
        <div id="chat-container"></div>

        <!-- Ticketing or Comment Widgets (future implementation) -->
        <!-- Placeholder for additional features -->
    </main>

    <!-- Footer -->
    <footer>
        <p>Contact us at <a href="mailto:support@integraled.org">support@integraled.org</a></p>
    </footer>

    <!-- Corrected JavaScript Path -->
    <!-- Remove or update this if accessibility.js is no longer used -->
    <!-- <script src="../../Assets/js/accessibility.js"></script> -->
    <script src="../../Assets/js/chat.js"></script>
    <script src="../../Assets/js/ie-core.js"></script>
    <script>
        // Function to wait for context from Softr or other sources
        function waitForContext(callback) {
            let maxAttempts = 20; // Maximum number of attempts
            let attempt = 0;
            let interval = 500; // Interval in milliseconds (0.5 seconds)

            const checkContext = () => {
                attempt++;
                // Check if Softr has provided context
                if (window.Softr && window.Softr.Context && window.Softr.Context.isReady) {
                    // Context is available
                    callback(window.Softr.Context.data);
                } else if (attempt < maxAttempts) {
                    // Context not yet available, try again after interval
                    setTimeout(checkContext, interval);
                } else {
                    // Context not available after maximum attempts, log error
                    console.error('Context not available after waiting.');
                    // Do not proceed without context
                    // You can decide to proceed with default context or show an error message to the user
                }
            };

            checkContext();
        }

        // Function to extract subdomain
        function getSubdomain() {
            const host = window.location.hostname; // e.g., "integral-mothership.softr.app"
            const domainParts = host.split('.');
            if (domainParts.length > 2) {
                // Extract subdomain(s)
                return domainParts.slice(0, domainParts.length - 2).join('.');
            } else {
                return '';
            }
        }

        // Wait for context and then initialize chat
        waitForContext(function(contextData) {
            let context = {};
            if (contextData) {
                context = contextData;
                console.log('Context received from Softr:', context);
            } else {
                console.log('No context provided after waiting.');
                // Do not proceed with chat initialization
                return;
            }

            // Extract subdomain as source
            const subdomain = getSubdomain();
            console.log('Subdomain:', subdomain);

            // Perform regex matching on subdomain to determine Source
            let source = 'unknown';
            if (/integral|iecentral|ie/i.test(subdomain)) {
                source = 'IE-Team';
            } else if (/bhb|bmore|baltimore/i.test(subdomain)) {
                source = 'bmore';
            } else {
                source = subdomain || 'unknown';
            }
            context.Source = source;

            // Determine client based on the URL path
            const pathSegments = window.location.pathname.split('/').filter(segment => segment);
            let client = '';

            if (pathSegments.includes('IECentral')) {
                client = 'IECentral';
            } else if (pathSegments.includes('BHB')) {
                client = 'BHB';
            } else {
                client = 'Other';
            }

            console.log('Client:', client);
            console.log('Updated Context:', context);

            // Initialize chat based on the client
            initializeChat(client, context);
        });

        document.addEventListener('SoftrContextReady', function(event) {
            const contextData = event.detail;
            // Proceed with the rest of your code using contextData
        });
    </script>
</body>
</html> 